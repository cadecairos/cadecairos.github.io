<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Popcorn Core Test Changes</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/highlighter/prettify.css?v=3a098a1af2" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css?v=3a098a1af2" />

    <script type='text/javascript' src="/assets/js/jquery-3.1.1.min.js?v=3a098a1af2"></script>
    <link rel="canonical" href="https://chrisdecairos.ca/popcorn-test-changes/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Chris DeCairos">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Popcorn Core Test Changes">
    <meta property="og:description" content="On Friday of last week I found myself hacking on a peculiar bug
[https://webmademovies.lighthouseapp.com/projects/63272/tickets/1405-position-function-can-throw-in-ie9-if-video-passed-in-has-never-had-a-parent-node] 
that I stumbled upon in Popcorn.js. The particulars of that bug aren&#x27;t very
important, the only important thing to mention right now is that it was a bug">
    <meta property="og:url" content="https://chrisdecairos.ca/popcorn-test-changes/">
    <meta property="article:published_time" content="2013-01-17T13:33:02.000Z">
    <meta property="article:modified_time" content="2018-08-22T02:24:40.000Z">
    <meta property="article:tag" content="CDOT">
    <meta property="article:tag" content="JavaScript">
    <meta property="article:tag" content="Mozilla-popcorn">
    <meta property="article:tag" content="mozillapopcorn">
    <meta property="article:tag" content="open-source">
    <meta property="article:tag" content="Popcorn">
    <meta property="article:tag" content="popcorn.js">
    <meta property="article:tag" content="unit tests">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Popcorn Core Test Changes">
    <meta name="twitter:description" content="On Friday of last week I found myself hacking on a peculiar bug
[https://webmademovies.lighthouseapp.com/projects/63272/tickets/1405-position-function-can-throw-in-ie9-if-video-passed-in-has-never-had-a-parent-node] 
that I stumbled upon in Popcorn.js. The particulars of that bug aren&#x27;t very
important, the only important thing to mention right now is that it was a bug">
    <meta name="twitter:url" content="https://chrisdecairos.ca/popcorn-test-changes/">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Chris DeCairos">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="CDOT, JavaScript, Mozilla-popcorn, mozillapopcorn, open-source, Popcorn, popcorn.js, unit tests">
    <meta name="twitter:site" content="@ChrisDeCairos">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Chris DeCairos",
        "url": "https://chrisdecairos.ca/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://chrisdecairos.ca/content/images/2020/12/profile--Small-.jpg"
        }
    },
    "author": {
        "@type": "Person",
        "name": "Chris DeCairos",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/5410ec660422c8ea12d4a28ef794a23a?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "https://chrisdecairos.ca/author/chris/",
        "sameAs": []
    },
    "headline": "Popcorn Core Test Changes",
    "url": "https://chrisdecairos.ca/popcorn-test-changes/",
    "datePublished": "2013-01-17T13:33:02.000Z",
    "dateModified": "2018-08-22T02:24:40.000Z",
    "keywords": "CDOT, JavaScript, Mozilla-popcorn, mozillapopcorn, open-source, Popcorn, popcorn.js, unit tests",
    "description": "On Friday of last week I found myself hacking on a peculiar bug\n[https://webmademovies.lighthouseapp.com/projects/63272/tickets/1405-position-function-can-throw-in-ie9-if-video-passed-in-has-never-had-a-parent-node] \nthat I stumbled upon in Popcorn.js. The particulars of that bug aren&#x27;t very\nimportant, the only important thing to mention right now is that it was a bug\nonly in Internet Explorer 9. For the better half of the day, I found myself\nrunning and re-running the tests in IE in a hopeless ",
    "mainEntityOfPage": "https://chrisdecairos.ca/popcorn-test-changes/"
}
    </script>

    <meta name="generator" content="Ghost 5.62">
    <link rel="alternate" type="application/rss+xml" title="Chris DeCairos" href="https://chrisdecairos.ca/rss/">
    
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="6155d3cf5dbae2dc7c7242039b" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://chrisdecairos.ca/" crossorigin="anonymous"></script>
    
    <link href="https://chrisdecairos.ca/webmentions/receive/" rel="webmention">
    <script defer src="/public/cards.min.js?v=3a098a1af2"></script><style>:root {--ghost-accent-color: #15171A;}</style>
    <link rel="stylesheet" type="text/css" href="/public/cards.min.css?v=3a098a1af2">
</head>
<body class="post-template tag-cdot tag-javascript tag-mozilla-popcorn tag-mozillapopcorn tag-open-source tag-popcorn tag-popcorn-js tag-unit-tests">

    

<main class="content" role="main">

    <article class="post tag-cdot tag-javascript tag-mozilla-popcorn tag-mozillapopcorn tag-open-source tag-popcorn tag-popcorn-js tag-unit-tests no-image">

        <header class="post-header">
            <a id="blog-logo" href="https://chrisdecairos.ca">
                    <img src="https://chrisdecairos.ca/content/images/2020/12/profile--Small-.jpg" alt="Blog Logo" />
            </a>
        </header>


        <span class="post-meta"><time datetime="2013-01-17">17 Jan 2013</time> on <a href="/tag/cdot/">CDOT</a> | <a href="/tag/javascript/">JavaScript</a> | <a href="/tag/mozilla-popcorn/">Mozilla-popcorn</a> | <a href="/tag/mozillapopcorn/">mozillapopcorn</a> | <a href="/tag/open-source/">open-source</a> | <a href="/tag/popcorn/">Popcorn</a> | <a href="/tag/popcorn-js/">popcorn.js</a> | <a href="/tag/unit-tests/">unit tests</a></span>

        <h1 class="post-title">Popcorn Core Test Changes</h1>

        <section class="post-content">
            <!--kg-card-begin: markdown--><p>On Friday of last week I found myself hacking on a <a href="https://webmademovies.lighthouseapp.com/projects/63272/tickets/1405-position-function-can-throw-in-ie9-if-video-passed-in-has-never-had-a-parent-node?ref=chrisdecairos.ca" target="_blank">peculiar bug</a> that I stumbled upon in Popcorn.js. The particulars of that bug aren't very important, the only important thing to mention right now is that it was a bug only in Internet Explorer 9. For the better half of the day, I found myself running and re-running the tests in IE in a hopeless attempt to even get to the test I needed to run. The thing with IE is that it is incredibly unpredictable when running the Popcorn.js core tests. A test could pass on one run, but then never pass again. And don't even get me started on compatibility view (more like incompatibility mode) which basically breaks the internet by turning off the &quot;addEventListener&quot; method...</p>
<p>Eventually, I got fed up and decided then and there that I was going to do something about it. From my experience working on these tests over the last couple years, I know first hand that the biggest problem is how the test cases re-use the testing media throughout the majority of the suite. Another major issue with the tests is that a failure in one case can ripple through the rest of the suite, creating false negatives.</p>
<!--more-->
<p>At that point, I could think of two solutions to the problem. The first would involve going through the 5000+ line test file, case by case, and figuring out how to ensure each could run without and worry about tests before and after it. What this would involve, is a foolproof way for each test to &quot;clean up&quot; regardless of a pass or fail. This would involve: resetting the media to 0 seconds, destroying any and all popcorn instances created during the test case, removing any DOM elements added during the test and removing any and all test plugins created for the purposes of the test case. That's a lot of work for over 130 sets of tests.</p>
<p>The second solution would involve &quot;sand-boxing&quot; each test case into it's own iframe, where it could run in an isolated environment and not have to worry about where it's starting or how it should leave the page after a pass or fail. This would be a lot of work as well, but in theory I could create a template page to use for each case, copy the case into a script tag on that page, and add/remove various dependencies (such as audio/video tags). As for running the tests, I already built the top-level test running framework which runs every test suite in the project. I'd need to make some changes to it, but the core functionality I needed was there.</p>
<p>All things considered, I chose to do the sand-boxing, simply because once it is completed, creating and debugging tests in the future should be a far more simple task than it is right now.</p>
<p>I started by creating a template page for each case to work with, and migrated the first 5 tests into their own files. From there, I turned to the test runner to see what modifications were needed. Turns out it was a little more complicated than I had originally anticipated. To get what I wanted done, without creating a separate runner, there were 3 things I needed to change:</p>
<ol>
	<li>The runner needed to take a test configuration file as a parameter when it's being instantiated, allowing for the specification of different sets of tests.</li>
	<li>The way the runner parsed the file would need to be changed. The original test runner used query strings and check boxes to determine which tests to actually run, but in the core test case, every test should be run.</li>
	<li>Results from tests would need to be posted to parent windows. This would allow for the main Popcorn Test runner to execute the core test runner in an iframe and receive the results.</li>
</ol>
After making the changes above and testing them on the 5 cases I had migrated, I felt confident that I could move forward. I spend the next few days (Monday, Tuesday) migrating the other ~125 tests over. It was definitely tedious, very repetitive work. Tuesday afternoon I wrapped up the migration, and was pleased to see that the tests all ran great in Firefox.
<p>Naturally, I wanted to see how they performed in IE9. Turned out that many of the test that actually depended on previous tests letting the media (audio/video) load, would try to access things like duration, or try to change the currentTime of the media before it was loaded. The rest of Tuesday and a majority of Wednesday I worked to update these tests with appropriate listeners for readyState. I also changed a few of the tests from synchronous tests to asynchronous tests.</p>
<p>Besides having to fix a few HTML5/CSS3 errors, and some visual issues with the test runner, By mid Wednesday, I had completed my work. For the first time in Popcorn.js testing history, you could reliably run our core unit tests without getting errors. I say that after testing on:</p>
<ul>
	<li>Firefox 18 (Mac &amp; Windows 7)</li>
	<li>Chrome 24 ( Mac ) There's a problem on Chrome 24 for Windows 7, The browser crashes because of a bug where it's creating too many media decoding threads and not cleaning them up fast enough. I can get them to pass if I pause between each test for about 1 second.</li>
	<li>Safari ( V6 on Mac, 5.1.7 on Windows 7)</li>
	<li>Opera 12.12 (Mac and Windows 7 )</li>
	<li>IE 9 (Windows 7)'</li>
</ul>
Considering that just days earlier, you could only reliably run these tests on Chrome and Firefox, this is a major improvement in the reliability of our tests. It will be easier to debug and improve tests without worrying about breaking others, and it should make creating new tests easier.
<p>Links:</p>
<ul>
	<li><a href="https://github.com/cadecairos/popcorn-js/tree/sandbox?ref=chrisdecairos.ca" target="_blank">GitHub branch</a></li>
	<li><a href="https://github.com/mozilla/popcorn-js/pull/268?ref=chrisdecairos.ca" target="_blank">Pull request</a></li>
	<li><a href="https://webmademovies.lighthouseapp.com/projects/63272-popcornjs/tickets/1411-sandbox-core-tests?ref=chrisdecairos.ca" target="_blank">Lightouse Ticket</a></li>
</ul>
&nbsp;<!--kg-card-end: markdown-->
        </section>

        <footer class="post-footer">

                <section class="author">
                    <h4>Chris DeCairos</h4>
                    <p></p>
                </section>

            <section class="share">
                <h4>Share this</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Popcorn Core Test Changes&url=https://chrisdecairos.ca/popcorn-test-changes/">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://chrisdecairos.ca/popcorn-test-changes/">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://chrisdecairos.ca/popcorn-test-changes/">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>


    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="https://chrisdecairos.ca/rss/"><span class="tooltip">Subscribe!</span></a>
        <div class="inner">
             <section class="copyright">All content copyright <a href="/">Chris DeCairos</a> &copy; 2024 &bull; All rights reserved.</section>
        </div>
    </footer>

    

    <script type='text/javascript' src="/assets/highlighter/prettify.js?v=3a098a1af2"></script>
    <script type='text/javascript' src="/assets/js/shell.js?v=3a098a1af2"></script>
</body>
</html>
